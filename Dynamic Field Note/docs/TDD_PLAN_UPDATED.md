# TDD計画 更新版（現実的スコープ）

**更新日**: 2025-10-18
**理由**: Phase A1, C1の経験から、現実的にテスト可能な範囲に絞る

---

## 完了したPhase

### ✅ Phase A1: markdownGenerator.ts

- **日時**: 2025-10-18
- **成果**: 38個のユニットテスト、dateFormatter統合
- **学び**: 純粋関数は単体テスト可能で時間対効果が高い

### ✅ Phase C1: geminiService.ts

- **日時**: 2025-10-18
- **成果**: テスタビリティ向上（export追加）、E2Eテストでカバー
- **学び**: 外部API依存コードは単体テストが困難、E2Eの方が実用的

---

## 更新された方針

### テスト戦略の分類

#### 🟢 単体テスト推奨

**対象**: 純粋関数、ビジネスロジック、Utils

- ✅ 外部依存なし
- ✅ 入力→出力が明確
- ✅ テスト作成が容易
- ✅ 時間対効果が高い

**例**:

- `src/utils/markdownGenerator.ts` ← 完了
- `src/utils/dateFormatter.ts` ← 完了
- `src/utils/validators/reportValidator.ts` ← 完了

#### 🟡 統合テスト推奨

**対象**: DAO層、データベース操作

- ✅ 既に実装済み
- ✅ 実際のDB操作をテスト
- ✅ 信頼性が高い

**例**:

- `src/dao/CaseDAO.ts` ← 完了
- `src/dao/PhotoDAO.ts` ← 完了
- `src/dao/ReportDAO.ts` ← 完了

#### 🔴 E2Eテスト推奨

**対象**: React Hooks、外部API依存、UI Components

- ⚠️ モックが複雑
- ⚠️ 環境依存が強い
- ✅ E2Eの方が実用的

**例**:

- `src/hooks/useSummarize.ts` ← E2Eでカバー
- `src/hooks/useVoiceBuffer.ts` ← E2Eでカバー
- `src/services/geminiService.ts` ← E2Eでカバー（リファクタリング済み）
- Components、Screens ← E2Eでカバー

---

## 現実的な今後の計画

### 優先順位1: 残りのUtils層（単体テスト可能）

現在、Utils層は3ファイル中2ファイル完了。残り1ファイルは存在しない可能性があるため確認が必要。

### 優先順位2: ドキュメント整備

テスト戦略を明文化：

- ✅ 単体テスト対象ファイルのリスト
- ✅ E2Eテスト対象ファイルのリスト
- ✅ テストカバレッジ目標の再設定

### 優先順位3: E2Eテストの強化（必要に応じて）

現在のE2Eテスト:

- `e2e/comprehensive/` - 基本的なカバレッジ
- `e2e/smoke/` - スモークテスト

必要に応じて追加:

- Hooks の実際の動作テスト
- API統合テスト
- UI コンポーネントの動作テスト

---

## 更新された目標

### 旧目標（非現実的）

- テストカバレッジ: 18% → 75%+
- 全26ファイルにテスト作成
- 5週間で完了

### 新目標（現実的）

#### 短期目標（1週間）

- ✅ Phase A1 完了（markdownGenerator.ts）
- ✅ Phase C1 完了（geminiService.ts リファクタリング）
- ⏳ TDD計画の更新（本ドキュメント）
- ⏳ テスト戦略の文書化

#### 中期目標（1ヶ月）

- 単体テスト可能な全Utilsのテスト作成
- E2Eテスト対象ファイルのリスト化
- テストカバレッジ: 実用的なレベル（詳細は後述）

#### 長期目標（3ヶ月）

- E2Eテストの段階的強化
- CI/CDへのテスト統合
- テスト文化の定着

---

## テストカバレッジの再定義

### 旧定義（ライン数カバレッジ）

- 問題: React Hooks、UI Componentsで現実的に達成困難
- 問題: モック作成に時間がかかりすぎる

### 新定義（機能カバレッジ）

#### Tier 1: 単体テスト（目標90%+）

**対象**: 純粋関数、ビジネスロジック、Utils

- ✅ markdownGenerator.ts: 90%+
- ✅ dateFormatter.ts: 90%+
- ✅ reportValidator.ts: 90%+

#### Tier 2: 統合テスト（目標80%+）

**対象**: DAO層、データベース操作

- ✅ CaseDAO.ts: 80%+
- ✅ PhotoDAO.ts: 80%+
- ✅ ReportDAO.ts: 80%+

#### Tier 3: E2Eテスト（主要フロー100%）

**対象**: React Hooks、API統合、UI

- ✅ useSummarize: 基本フロー
- ⏳ useVoiceBuffer: 今後強化
- ⏳ Components: 今後強化

---

## アクションプラン

### 即時（今日〜明日）

1. ✅ Phase C1 完了・コミット
2. ✅ TDD計画更新（本ドキュメント）
3. ⏳ COMPREHENSIVE_TDD_REFACTORING_PLAN.md を非推奨化

### 短期（1週間）

1. 残りのUtils層の確認
2. E2Eテスト対象ファイルのリスト化
3. テストカバレッジレポート生成

### 中期（1ヶ月）

1. Utils層の完全なテストカバレッジ達成
2. E2Eテストの段階的追加
3. CI/CD統合の準備

---

## 学習と改善

### Phase A1 & C1 から学んだこと

#### ✅ うまくいったこと

- 純粋関数の単体テストは時間対効果が高い
- リファクタリング（export追加）だけでもテスタビリティ向上
- ドキュメント化で判断基準が明確に

#### ⚠️ うまくいかなかったこと

- 外部API依存のモックテストは複雑すぎる
- React Hooksの単体テストは環境設定が困難
- 完璧主義は時間の無駄

#### 💡 今後に活かすこと

- テスト可能性を考慮したコード設計
- E2Eテストを積極的に活用
- 現実的な目標設定

---

## まとめ

### 旧計画の問題点

- すべてのファイルに単体テスト = 非現実的
- モック作成に時間がかかりすぎ
- 時間対効果を考慮していない

### 新計画の特徴

- **現実的**: テスト可能なものに集中
- **実用的**: E2Eテストを積極活用
- **持続可能**: 時間対効果を重視

### 成功の定義

- ✅ 全単体テスト可能なファイルに90%+カバレッジ
- ✅ E2E主要フロー100%カバレッジ
- ✅ CI/CD統合完了
- ✅ チーム全体のテスト文化定着

---

**次のステップ**:

1. 本ドキュメントをコミット
2. COMPREHENSIVE_TDD_REFACTORING_PLAN.md に非推奨マークを追加
3. 次のフェーズ（残りUtils or E2E強化）を決定
